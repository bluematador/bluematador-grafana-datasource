{"version":3,"sources":["../src/datasource.js"],"names":["BlueMatadorDatasource","instanceSettings","$q","backendSrv","templateSrv","url","jsonData","trim","accountId","apikey","q","withCredentials","headers","basicAuth","length","options","query","Promise","resolve","status","message","title","doRequest","method","then","response","catch","lastQuery","clone","add","isAfter","lastAnnotations","start","range","from","toISOString","end","to","annotation","limit","annotations","result","data","map","source","event","sourceType","sourceName","details","d","join","closed","Date","toLocaleString","link","name","enabled","enable","datasource","time","text","summary","tags","datasourceRequest"],"mappings":"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","file":"datasource.js","sourcesContent":["import moment from 'moment';\nimport './css/main.css!';\n\nexport class BlueMatadorDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.url = instanceSettings.jsonData.url.trim() || 'https://app.bluematador.com/';\n    this.accountId = instanceSettings.jsonData.accountId.trim();\n    this.apikey = instanceSettings.jsonData.apikey.trim();\n\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.headers = {'Content-Type': 'application/json'};\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n  }\n\n  query(options) {}\n  metricFindQuery(query) {}\n\n  testDatasource() {\n    if (!this.accountId || !this.apikey) {\n      return Promise.resolve({\n        status: 'error',\n        message: 'Finish configuring the datasource before testing',\n        title: 'Error',\n      });\n    }\n\n    return this.doRequest({\n      url: `${this.url}ma/accounts/${this.accountId}/grafana/test`,\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: 'success', message: 'Data source is working', title: 'Success' };\n      }\n    }).catch(err => ({\n      status: 'error',\n      message: 'Unable to connect to data source',\n      title: 'Error',\n    }));\n  }\n\n  annotationQuery(options) {\n    if (this.lastQuery && this.lastQuery.clone().add(1, 'minutes').isAfter(moment())) {\n      return this.lastAnnotations;\n    }\n    this.lastQuery = moment();\n\n    const start = options.range.from.toISOString();\n    const end = options.range.to.toISOString();\n    return this.doRequest({\n      url: `${this.url}ma/accounts/${this.accountId}/grafana/${options.annotation.query}?start=${start}&end=${end}&limit=${options.annotation.limit}`,\n      method: 'GET',\n    }).then(result => {\n      const annotations = result.data.map(event => {\n        const source = `<em>${event.sourceType}: ${event.sourceName}</em>`;\n        const details = event.details.length > 0 ?\n          `<ul class=\"bm-list\">${event.details.map(d => `<li>${d}</li>`).join('')}</ul>` :\n          '';\n        const closed = event.closed ? `Closed: ${(new Date(event.closed)).toLocaleString()}` : '';\n        const link = `<a href=\"${event.link}\" target=\"_blank\">Open in Blue Matador</a>`;\n\n        return {\n          annotation: {\n            name: options.annotation.name,\n            enabled: options.annotation.enable,\n            datasource: options.annotation.datasource,\n          },\n          title: event.title,\n          time: event.time,\n          text: `${source}<br />${closed}<br />${event.summary}${details && ':'}<br />${details}<br />${link}`,\n          tags: event.tags,\n        };\n      });\n\n      this.lastAnnotations = annotations;\n      return annotations;\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n    options.headers['Authorization'] = this.apikey;\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n}\n"]}